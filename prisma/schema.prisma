// ===================== Datasource & Generator =====================
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ===================== Models =====================

// ---- User ----
model User {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  password     String
  role         String  @default("USER")
  tokenVersion Int     @default(0)
  banned       Boolean @default(false)

  // ƒê√£ kh·ªõp ki·ªÉu String? v√† th√™m @unique ƒë·ªÉ ƒë·∫£m b·∫£o 1:0..1
  selectedBankId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wallet Wallet?

  // 1-n v·ªõi BankAccount
  banks BankAccount[] @relation("UserBanks")

  withdrawals Withdrawal[]
  history     WalletHistory[]
  commissions Commission[]
  tickets     SupportTicket[]
  messages    ChatMessage[]
  otpRequests OtpRequest[]

  // ng√¢n h√†ng ƒëang ch·ªçn (Quan h·ªá 1:0..1)
  selectedBank BankAccount? @relation("SelectedBank", fields: [selectedBankId], references: [id])
}

// ---- Wallet ----
model Wallet {
  userId   Int     @id
  user     User    @relation(fields: [userId], references: [id])
  balance  Decimal @default(0)
  currency String  @default("VND")
}

// ---- WalletHistory ----
model WalletHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  text      String
  sub       String?
  amount    Decimal?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

// ---- BankAccount ----
model BankAccount {
  id         String   @id @default(cuid())

  // S·ª≠a: Ph·∫£i l√† Int? v√† User? ƒë·ªÉ cho ph√©p t·∫°o BankAccount m√† kh√¥ng c·∫ßn User ID ngay
  userId     Int?                // üëà C·∫ßn th√™m d·∫•u ?
  user       User?    @relation("UserBanks", fields: [userId], references: [id]) // üëà C·∫ßn th√™m d·∫•u ?

  // ƒë·ªëi ·ª©ng cho "SelectedBank"
  selectedBy User?    @relation("SelectedBank")

  bankName   String
  number     String
  holder     String
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId, isDefault])
}

// ---- Withdrawal ----
model Withdrawal {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  amount        Decimal
  fee           Decimal @default(0)
  status        String  @default("QUEUED") // thay enum b·∫±ng String
  method        String?
  bankName      String?
  bankAccount   String?
  transactionId String?
  note          String?

  idempotencyKey String?  @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status, createdAt])
}

// ---- Commission ----
model Commission {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  amount    Decimal
  status    String
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model SupportTicket {
  id             Int      @id @default(autoincrement())
  userId         Int
  user           User     @relation(fields: [userId], references: [id])
  room           String
  title          String
  status         String   @default("OPEN")
  firstMessageId Int?
  createdAt      DateTime @default(now())
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  room      String
  from      String   // "agent" | "user" | "system"
  text      String
  createdAt DateTime @default(now())

  @@index([userId, room, createdAt])
}


// ---- OtpRequest ----
model OtpRequest {
  id        Int       @id @default(autoincrement())
  userId    Int?
  user      User?     @relation(fields: [userId], references: [id])
  email     String
  codeHash  String
  type      String
  verified  Boolean   @default(false)
  expireAt  DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([email, expireAt])
  @@index([userId, createdAt])
}

// ---- IdempotencyRecord ----
model IdempotencyRecord {
  idempotencyKey String   @id
  endpoint       String
  expireAt       DateTime
  responseStatus Int?
  responseBody   String?
  createdAt      DateTime @default(now())

  @@index([endpoint, expireAt])
}
